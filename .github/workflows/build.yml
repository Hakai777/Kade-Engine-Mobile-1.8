name: Build Kade Engine APK (Java 8 + SDK Android)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      JAVA_HOME_8: /usr/lib/jvm/java-8-openjdk-amd64
      ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
      HAXE_VERSION: 4.1.5
      LIME_VERSION: 8.0.2
      OPENFL_VERSION: 9.2.2
      ANDROID_API_LEVEL: 28
      ANDROID_BUILD_TOOLS: 28.0.3

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Setup Java 8
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: 8

    - name: Verify java version
      run: java -version

    - name: Setup Android SDK
      run: |
        mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
        cd $ANDROID_SDK_ROOT/cmdline-tools
        curl -o commandlinetools.zip https://dl.google.com/android/repository/commandlinetools-linux-6609375_latest.zip
        unzip commandlinetools.zip
        # O unzip cria uma pasta cmdline-tools
        mv cmdline-tools latest
      shell: bash

    - name: Add sdkmanager to PATH
      run: echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH

    - name: Accept licenses and install SDK packages
      run: |
        yes | sdkmanager --licenses
        sdkmanager "platforms;android-${ANDROID_API_LEVEL}" "build-tools;${ANDROID_BUILD_TOOLS}"
      shell: bash

    - name: Download and install Haxe ${HAXE_VERSION}
      run: |
        curl -LO https://github.com/HaxeFoundation/haxe/releases/download/${HAXE_VERSION}/haxe-${HAXE_VERSION}-linux64.tar.gz
        tar -xf haxe-${HAXE_VERSION}-linux64.tar.gz
        sudo mv haxe-${HAXE_VERSION} /usr/local/haxe
        echo "/usr/local/haxe/bin" >> $GITHUB_PATH
      shell: bash

    - name: Verify Haxe version
      run: haxe --version

    - name: Build APK
      run: |
        # Ajuste o comando abaixo conforme o seu build system do Kade Engine
        lime test android -debug
      shell: bash
