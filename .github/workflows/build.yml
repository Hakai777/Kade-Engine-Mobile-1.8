name: Build Kade Engine APK (Java 8 + SDK compatÃ­vel)

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  HAXE_VERSION: "4.1.5"
  LIME_VERSION: "7.7.0"
  OPENFL_VERSION: "8.10.6"
  ANDROID_PLATFORM: "android-28"
  ANDROID_BUILD_TOOLS: "28.0.3"

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ANDROID_SDK_ROOT: $HOME/Android

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Setup Java 8 (Temurin)
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 8

    - name: Download and install Android SDK cmdline-tools compatible with Java 8
      run: |
        mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
        cd $ANDROID_SDK_ROOT
        wget https://dl.google.com/android/repository/commandlinetools-linux-6200805_latest.zip -O cmdline-tools.zip
        unzip cmdline-tools.zip -d cmdline-tools-temp
        mkdir -p cmdline-tools/latest
        mv cmdline-tools-temp/cmdline-tools/* cmdline-tools/latest/
        rm -rf cmdline-tools-temp cmdline-tools.zip

    - name: Set PATH for Android SDK tools
      run: |
        echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH

    - name: Install Android SDK platforms and build tools
      run: |
        sdkmanager "platforms;${ANDROID_PLATFORM}" "build-tools;${ANDROID_BUILD_TOOLS}" "platform-tools"
        yes | sdkmanager --licenses

    - name: Install Haxe
      run: |
        wget https://github.com/HaxeFoundation/haxe/releases/download/${HAXE_VERSION}/haxe-${HAXE_VERSION}-linux64.tar.gz
        tar -xzf haxe-${HAXE_VERSION}-linux64.tar.gz
        sudo mv haxe-${HAXE_VERSION} /usr/lib/haxe
        sudo ln -s /usr/lib/haxe/haxe /usr/bin/haxe
        sudo ln -s /usr/lib/haxe/haxelib /usr/bin/haxelib

    - name: Install haxelib libraries (Lime, OpenFL, extension-webm)
      run: |
        haxelib setup /usr/lib/haxe/lib
        haxelib install lime ${LIME_VERSION}
        haxelib install openfl ${OPENFL_VERSION}
        # Extension-webm deve ser linkada como no repo da Kade Engine
        haxelib git extension-webm https://github.com/KadeDev/extension-webm.git

    - name: Compile APK (Kade Engine 1.8)
      run: |
        lime rebuild android -clean

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: kade-engine-apk
        path: bin/android/bin/*.apk
