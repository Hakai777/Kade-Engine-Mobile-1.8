name: Build Kade Engine APK (Java 8 + manual SDK install)

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  HAXE_VERSION: "4.1.5"
  LIME_VERSION: "7.7.0"
  OPENFL_VERSION: "8.10.6"
  ANDROID_SDK_ROOT: ${{ env.HOME }}/Android
  ANDROID_PLATFORM: "android-28"
  ANDROID_BUILD_TOOLS: "28.0.3"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Java 8
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: 8

    - name: Download and install Android SDK cmdline-tools (older compatible version)
      run: |
        mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
        cd $ANDROID_SDK_ROOT
        wget https://dl.google.com/android/repository/commandlinetools-linux-6200805_latest.zip -O cmdline-tools.zip
        unzip cmdline-tools.zip -d cmdline-tools-temp
        mkdir -p cmdline-tools/latest
        mv cmdline-tools-temp/cmdline-tools/* cmdline-tools/latest/
        rm -rf cmdline-tools-temp cmdline-tools.zip

    - name: Add Android SDK tools to PATH
      run: echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH

    - name: Accept Android licenses
      run: yes | sdkmanager --sdk_root=$ANDROID_SDK_ROOT --licenses

    - name: Install SDK platform and build-tools
      run: |
        sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platforms;${ANDROID_PLATFORM}" "build-tools;${ANDROID_BUILD_TOOLS}"

    - name: Setup Haxe ${HAXE_VERSION}
      run: |
        wget https://github.com/HaxeFoundation/haxe/releases/download/${HAXE_VERSION}/haxe-${HAXE_VERSION}-linux64.tar.gz
        tar -xzf haxe-${HAXE_VERSION}-linux64.tar.gz
        sudo mv haxe-${HAXE_VERSION} /usr/lib/haxe
        sudo ln -sf /usr/lib/haxe/haxe /usr/bin/haxe
        sudo ln -sf /usr/lib/haxe/haxelib /usr/bin/haxelib
        haxelib setup /usr/lib/haxe/lib

    - name: Install Lime and OpenFL from Kade Engine versions
      run: |
        haxelib install lime ${LIME_VERSION}
        haxelib install openfl ${OPENFL_VERSION}
        haxelib git lime https://github.com/KadeDev/Lime.git ${LIME_VERSION}
        haxelib git openfl https://github.com/KadeDev/OpenFL.git ${OPENFL_VERSION}
        haxelib run lime setup

    - name: Install extension-webm for Kade Engine
      run: |
        haxelib git extension-webm https://github.com/KadeDev/extension-webm.git

    - name: Build APK debug
      run: |
        lime build android -debug -android

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: kade-engine-apk
        path: ./bin/android/bin/KadeEngine-debug.apk
