name: Build Kade Engine APK

on:
  push:
    branches:
      - main
  pull_request:

env:
  HAXE_VERSION: 4.2.5
  HAXELIB_DIR: /home/runner/haxelib

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget curl unzip zip neko libneko2 openjdk-11-jdk android-sdk android-sdk-platform-30

    - name: Install Haxe ${{ env.HAXE_VERSION }}
      run: |
        set -e
        HAXE_TAR="haxe-${{ env.HAXE_VERSION }}-linux64.tar.gz"
        wget -q "https://github.com/HaxeFoundation/haxe/releases/download/${{ env.HAXE_VERSION }}/$HAXE_TAR" -O /tmp/$HAXE_TAR
        tar -xzf /tmp/$HAXE_TAR -C /tmp
        sudo mv /tmp/haxe-${{ env.HAXE_VERSION }} /opt/haxe
        sudo ln -sf /opt/haxe/haxe /usr/local/bin/haxe
        sudo ln -sf /opt/haxe/haxelib /usr/local/bin/haxelib
        export PATH="/opt/haxe:$PATH"
        haxe --version
        haxelib setup ${{ env.HAXELIB_DIR }}

    - name: Install Haxe libraries
      run: |
        export PATH="/opt/haxe:$PATH"
        haxelib install lime
        haxelib install openfl
        haxelib install actuate
        haxelib install flixel
        haxelib install flixel-addons
        haxelib install flixel-ui
        haxelib run lime setup -alias -y
        haxelib run lime config ANDROID_SDK $ANDROID_HOME
        haxelib run lime config JAVA_HOME /usr/lib/jvm/java-11-openjdk-amd64

    - name: Build APK
      run: |
        export PATH="/opt/haxe:$PATH"
        haxelib run lime build android -final

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: kade-engine-apk
        path: export/release/android/bin/app/build/outputs/apk/release/*.apk
