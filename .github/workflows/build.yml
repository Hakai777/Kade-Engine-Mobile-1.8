name: Build Kade Engine APK

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Update and install dependencies
      run: |
        sudo apt update
        sudo apt install -y curl unzip zip neko

    - name: Download Haxe 4.2.5
      run: curl -L https://github.com/HaxeFoundation/haxe/releases/download/4.2.5/haxe-4.2.5-linux64.tar.gz -o haxe.tar.gz

    - name: Extract Haxe
      run: tar -xzf haxe.tar.gz

    - name: Move Haxe folder (try possible names)
      run: |
        if [ -d "haxe-4.2.5-linux64" ]; then
          mv haxe-4.2.5-linux64 haxe
        elif [ -d "haxe-4.2.5" ]; then
          mv haxe-4.2.5 haxe
        else
          echo "Haxe folder not found, skipping move"
        fi

    - name: Add Haxe to PATH
      run: echo "${{ github.workspace }}/haxe" >> $GITHUB_PATH

    - name: Verify Haxe version
      run: haxe --version

    - name: Build Kade Engine
      run: |
        haxelib setup ~/.haxelib
        haxelib install lime
        haxelib install openfl
        haxelib install format
        haxelib run lime build android -clean -final

    - name: Upload APK artifact
      uses: actions/upload-artifact@v3
      with:
        name: kade-engine-apk
        path: bin/android/bin/KadeEngine.apk
